# CSRF interceptor
In this example, we will try to create go-zero server with csrf middleware enabled.

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [Quick start](#quick-start)
  - [Code](#code)
- [Options](#options)
  - [Context Usage](#context-usage)
- [Example](#example)
    - [Start server](#start-server)
    - [Send request](#send-request)
    - [Code](#code-1)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Quick start
Get rk-zero package from the remote repository.

```go
go get -u github.com/rookie-ninja/rk-zero
```

### Code
Add rkzerocsrf.Interceptor() csrf with option.

```go
import     "github.com/rookie-ninja/rk-zero/interceptor/csrf"
```
```go
    // ********************************************
    // ********** Enable interceptors *************
    // ********************************************
	interceptors := []rest.Middleware{
		rkzerocsrf.Interceptor(),
    }
```

## Options
| Name | Description | Default Values |
| ---- | ---- | ---- |
| rkzerocsrf.WithEntryNameAndType(entryName, entryType string) | Optional. Provide entry name and type if there are multiple csrf interceptors needs to be used. | zero, zero |
| rkzerocsrf.WithSkipper(skipper function) | Optional. Provide skipper function | function always returns false |
| rkzerocsrf.WithTokenLength(int) | Optional. Provide the length of the generated token. | 32 |
| rkzerocsrf.WithTokenLookup(string) | Optional, provide csrf token lookup rules, please see code comments for details. | "header:X-CSRF-Token" |
| rkzerocsrf.WithCookieName(string) | Optional, Provide name of the CSRF cookie. This cookie will store CSRF token. | csrf |
| rkzerocsrf.WithCookieDomain(string) | Optional, domain of the CSRF cookie. | "" |
| rkzerocsrf.WithCookiePath(string) | Optional, path of the CSRF cookie. | "" |
| rkzerocsrf.WithCookieMaxAge(int) | Optional, provide max age (in seconds) of the CSRF cookie. | 86400 (24hr). |
| rkzerocsrf.WithCookieHTTPOnly(bool) | Optional, indicates if CSRF cookie is HTTP only. | false | 
| rkzerocsrf.WithCookieSameSite(http.SameSite) | Optional, indicates SameSite mode of the CSRF cookie. | SameSiteDefaultMode |

```go
    // ********************************************
    // ********** Enable interceptors *************
    // ********************************************
	interceptors := []rest.Middleware{
		rkzerocsrf.Interceptor(
			// Required, entry name and entry type will be used for distinguishing interceptors. Recommended.
			rkzerocsrf.WithEntryNameAndType("greeter", "zero"),
			//
			// Optional, provide skipper function
			//rkzerocsrf.WithSkipper(func(req *http.Request) bool {
			//	return true
			//}),
			//
			// WithTokenLength the length of the generated token.
			// Optional. Default value 32.
			//rkzerocsrf.WithTokenLength(10),
			//
			// WithTokenLookup a string in the form of "<source>:<key>" that is used
			// to extract token from the request.
			// Optional. Default value "header:X-CSRF-Token".
			// Possible values:
			// - "header:<name>"
			// - "form:<name>"
			// - "query:<name>"
			// Optional. Default value "header:X-CSRF-Token".
			//rkzerocsrf.WithTokenLookup("header:X-CSRF-Token"),
			//
			// WithCookieName provide name of the CSRF cookie. This cookie will store CSRF token.
			// Optional. Default value "csrf".
			//rkzerocsrf.WithCookieName("csrf"),
			//
			// WithCookieDomain provide domain of the CSRF cookie.
			// Optional. Default value "".
			//rkzerocsrf.WithCookieDomain(""),
			//
			// WithCookiePath provide path of the CSRF cookie.
			// Optional. Default value "".
			//rkzerocsrf.WithCookiePath(""),
			//
			// WithCookieMaxAge provide max age (in seconds) of the CSRF cookie.
			// Optional. Default value 86400 (24hr).
			//rkzerocsrf.WithCookieMaxAge(10),
			//
			// WithCookieHTTPOnly indicates if CSRF cookie is HTTP only.
			// Optional. Default value false.
			//rkzerocsrf.WithCookieHTTPOnly(false),
			//
			// WithCookieSameSite indicates SameSite mode of the CSRF cookie.
			// Optional. Default value SameSiteDefaultMode.
			//rkzerocsrf.WithCookieSameSite(http.SameSiteStrictMode),
		),
	}
```

### Context Usage
| Name | Functionality |
| ------ | ------ |
| rkzeroctx.GetLogger(*http.Request, http.ResponseWriter) | Get logger generated by log interceptor. If there are X-Request-Id or X-Trace-Id as headers in incoming and outgoing metadata, then loggers will has requestId and traceId attached by default. |
| rkzeroctx.GetEvent(*http.Request) | Get event generated by log interceptor. Event would be printed as soon as RPC finished. |
| rkzeroctx.GetIncomingHeaders(*http.Request) | Get incoming header. |
| rkzeroctx.AddHeaderToClient(http.ResponseWriter, "k", "v") | Add k/v to headers which would be sent to client. This is append operation. |
| rkzeroctx.SetHeaderToClient(http.ResponseWriter, "k", "v") | Set k/v to headers which would be sent to client. |
| rkzeroctx.GetJwtToken(*http.Request) | Get jwt token if exists |
| rkzeroctx.GetCsrfToken(*http.Request) | Get csrf token if exists |

## Example
#### Start server
```shell script
$ go run greeter-server.go
```

#### Send request
- Send GET request, no csrf validation expected and a new cookie should be there.

```shell script
$ curl -X GET -vs localhost:8080/rk/v1/greeter
  *   Trying ::1...
  * TCP_NODELAY set
  * Connected to localhost (::1) port 8080 (#0)
  > GET /rk/v1/greeter HTTP/1.1
  > Host: localhost:8080
  > User-Agent: curl/7.64.1
  > Accept: */*
  >
  < HTTP/1.1 200 OK
  < Content-Type: application/json; charset=UTF-8
  < Set-Cookie: _csrf=XVlBzgbaiCMRAjWwhTHctcuAxhxKQFDa; Expires=Sat, 04 Dec 2021 13:44:41 GMT
  < Vary: Cookie
  < Date: Fri, 03 Dec 2021 13:44:41 GMT
  < Content-Length: 58
  <
  {"Message":"CSRF token:XVlBzgbaiCMRAjWwhTHctcuAxhxKQFDa"}
```

- POST method with happy case

```shell script
$ curl -X POST -v --cookie "_csrf=my-test-csrf-token" -H "X-CSRF-Token:my-test-csrf-token" localhost:8080/rk/v1/greeter
  *   Trying ::1...
  * TCP_NODELAY set
  * Connected to localhost (::1) port 8080 (#0)
  > POST /rk/v1/greeter HTTP/1.1
  > Host: localhost:8080
  > User-Agent: curl/7.64.1
  > Accept: */*
  > Cookie: _csrf=my-test-csrf-token
  > X-CSRF-Token:my-test-csrf-token
  >
  < HTTP/1.1 200 OK
  < Content-Type: application/json; charset=UTF-8
  < Set-Cookie: _csrf=my-test-csrf-token; Expires=Sat, 04 Dec 2021 13:54:17 GMT
  < Vary: Cookie
  < Date: Fri, 03 Dec 2021 13:54:17 GMT
  < Content-Length: 44
  <
  {"Message":"CSRF token:my-test-csrf-token"}
```

- POST method with invalid csrf
```shell script
$ curl -X POST -v -H "X-CSRF-Token:my-test-csrf-token" localhost:8080/rk/v1/greeter
  *   Trying ::1...
  * TCP_NODELAY set
  * Connected to localhost (::1) port 8080 (#0)
  > POST /rk/v1/greeter HTTP/1.1
  > Host: localhost:8080
  > User-Agent: curl/7.64.1
  > Accept: */*
  > X-CSRF-Token:my-test-csrf-token
  >
  < HTTP/1.1 403 Forbidden
  < Content-Type: application/json; charset=UTF-8
  < Date: Fri, 03 Dec 2021 13:55:11 GMT
  < Content-Length: 92
  <
  {"error":{"code":403,"status":"Forbidden","message":"invalid csrf token","details":[]}}
```

#### Code

- [greeter-server.go](greeter-server.go)
